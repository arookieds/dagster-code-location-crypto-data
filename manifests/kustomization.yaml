# Dagster Crypto Data Code Location - Kubernetes Deployment
# Deploys a Dagster user code location using Helm chart override pattern

apiVersion: kustomize.config.k8s.io/v1beta1
kind: Kustomization
namespace: dagster

resources:
  - configmap.yaml
  - sealed-secrets/dagster-crypto-secrets-sealed.yaml

helmCharts:
  - name: dagster-user-deployments
    repo: https://dagster-io.github.io/helm
    version: 1.12.8
    releaseName: crypto-data
    namespace: dagster
    valuesInline:
      global:
        postgresqlSecretName: "dagster-crypto-secrets"
      deployments:
        - name: "crypto-data"
          image:
            repository: "ghcr.io/arookieds/dagster-code-location-crypto-data"
            tag: "latest"
            pullPolicy: "Always"

          dagsterApiGrpcArgs:
            - "--module-name"
            - "dagster_crypto_data.definitions"

          port: 3030

          # Environment variables from ConfigMap
          envConfigMaps:
            - name: dagster-crypto-config

          # Environment variables from Secrets
          envSecrets:
            - name: dagster-crypto-secrets

          # Additional environment variables
          env: []
          # Resource limits
          resources:
            limits:
              cpu: 500m
              memory: 512Mi
            requests:
              cpu: 100m
              memory: 256Mi

          # Liveness probe
          livenessProbe:
            exec:
              command:
                - "python"
                - "-c"
                - "import dagster; print('alive')"
            initialDelaySeconds: 30
            periodSeconds: 30
            timeoutSeconds: 10
            failureThreshold: 3

          # Readiness probe
          readinessProbe:
            enabled: False
            initialDelaySeconds: 10
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 3

          # Security context
          securityContext:
            runAsNonRoot: true
            runAsUser: 1000
            allowPrivilegeEscalation: false
            readOnlyRootFilesystem: false
            capabilities:
              drop:
                - ALL

          # Pod security context
          podSecurityContext:
            fsGroup: 1000

          # Service configuration
          service:
            type: ClusterIP
            port: 3030

          # Annotations
          annotations:
            description: "Dagster code location for crypto data pipelines"
            repository: "https://github.com/arookieds/dagster-code-location-crypto-data"

metadata:
  labels:
    project: dagster-crypto-data

  annotations:
    managed-by: "kustomize"

patches:
  - target:
      kind: Deployment
      labelSelector: "app.kubernetes.io/instance=crypto-data,component=user-deployments"
    patch: |
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: placeholder-name-for-validation
      spec:
        template:
          spec:
            containers:
              - name: dagster-user-deployments
                env:
                  - name: DAGSTER_PG_PASSWORD
                    valueFrom:
                      secretKeyRef:
                        name: dagster-crypto-secrets
                        key: DB_PASSWORD
